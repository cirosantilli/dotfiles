#!/usr/bin/env bash

# Synchronize my computers: push changes to remote.

all=''
while getopts a OPT; do
  case "$OPT" in
    a)
      all=-a
      ;;
  esac
done

sync_msg='sync'
homesick commit dotfiles "$sync_msg"
homesick push
git-sync-dirs $all | while read path; do
  tmpfile="$(mktemp)"
  printf "\n\e[1;33m## $path\e[0m\n\n" >"$tmpfile"
  cd "$path"
  git add -A . >/dev/null 2>&1
  git commit -m "$sync_msg" >/dev/null 2>&1
  git push >>"$tmpfile" 2>&1
  if [ "$?" = 0 ]; then
    echo '.'
  else
    cat "$tmpfile"
  fi
  rm "$tmpfile"
done
